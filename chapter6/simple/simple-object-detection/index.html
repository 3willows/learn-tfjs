<!DOCTYPE html>
<html>
  <head>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@2.7.0/dist/tf.min.js"></script>
  </head>
  <body>
    <h1>AI Sees You!</h1>
    <div style="position: relative; height: 80vh">
      <img id="mystery" src="/dinner.jpg" height="100%" />
      <canvas id="detection" style="position: absolute; left: 0" />
    </div>

    <script type="module">
      import { CLASSES } from "./labels.js";

      async function performDetections() {
        await tf.ready()
        const modelPath =
          "https://tfhub.dev/tensorflow/tfjs-model/ssd_mobilenet_v2/1/default/1";

        const model = await tf.loadGraphModel(modelPath, { fromTFHub: true })
        const mysteryImage = document.getElementById("mystery");
        const myTensor = tf.browser.fromPixels(mysteryImage);
        // SSD Mobilenet single batch
        const readyfied = tf.expandDims(myTensor, 0);
        const results = await model.executeAsync(readyfied)
        // Get a clean tensor of indices
        const { indices } = tf.topk(results[0].squeeze(), 1);
        // Move results back into JavaScript in parallel
        const detections = await indices.array()
        const boxes = await results[1].squeeze().array()
        // const [detections, boxes] = Promise.all([
        //   indices.array(),
        //   results[1].squeeze().array()
        // ])

        console.log('Detections', detections)
        console.log('Boxes', boxes)

        // Prep Canvas
        const detection = document.getElementById("detection");
        const ctx = detection.getContext("2d");
        ctx.strokeStyle = "#0F0";
        ctx.lineWidth = 4;
        const imgWidth = mysteryImage.width;
        const imgHeight = mysteryImage.height;
        detection.width = imgWidth;
        detection.height = imgHeight;


        // const box = result.dataSync();
        // const startX = box[0] * imgWidth;
        // const startY = box[1] * imgHeight;
        // const width = (box[2] - box[0]) * imgWidth;
        // const height = (box[3] - box[1]) * imgHeight;
        // ctx.strokeRect(startX, startY, width, height);

      }

      performDetections()
    </script>
  </body>
</html>
